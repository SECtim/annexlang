options: {}
protocol:
  !Protocol
  parties:
  - &idp1
    !Party
    name: <i class="fas fa-server"></i> IdP
    style: server
  - &b1i
    !Party
    name: <i class="fas fa-file"></i> <code>idp.example/</code>
  - &b1d
    !Party
    name: <i class="fas fa-file"></i> <code>example.com/</code>
  - &example
    !Party
    name: <i class="fas fa-server"></i> example.com
    extrawidth: 0.1\textwidth
    style: server
  - &b2d
    !Party
    name: <i class="fas fa-file"></i> <code>example.com/</code>
  - &b2i
    !Party
    name: <i class="fas fa-file"></i> <code>idp.example/</code>
  - &idp2
    !Party
    name: <i class="fas fa-server"></i> IdP
    style: server
  
  groups:
  - !Group
    name: <i class="fas fa-firefox"></i> Browser A
    parties:
      - *b1d
      - *b1i
  - !Group
    name: <i class="fas fa-chrome"></i> Browser B
    parties:
      - *b2d
      - *b2i
  steps:
# INITIALIZATION
  - !Parallel
    steps:
      - !start-party
        party: *b1d
      - !start-party
        party: *idp1
      - !start-party
        party: *example
      - !start-party
        party: *b2d
      - !start-party
        party: *idp2
# STARTUP
  - !Parallel
    steps:
      - !Serial # in browser 1
        steps:
         - !http-request &get_doc_1
           src: *b1d
           dest: *example
           method: GET
           id: some-request
         - !http-response
           reply_to: *get_doc_1
           id: some-response
         - !action
           label: <code>CREATE_PEER_CONNECTION</code>
           party: *b1d
         - !open-window-start-party
           src: *b1d
           dest: *b1i
         - !http-request-response &get_doc_2
           src: *b1i
           dest: *idp1
           method: GET
           url: /.wk/idp-proxy
         - !script-action
           dest: *b1d
           src: *b1i
           label: <code>GET_IA_INFO</code>
           reversed: yes
           data: stuff
         - !script-action
           label: <code>SET_IA</code>
           dest: *b1d
           src: *b1i
           data: results
         - !end-party
           party: *b1i             
         - !action
           label: <code>GET_OFFERdd</code>
           party: *b1d
           
      - !Serial # in browser 2
        condense: west
        id: condensed
        steps:
        - !http-request &get_doc_3
          src: *b2d
          dest: *example
          method: GET
        - !http-response
          reply_to: *get_doc_3
        - !action
          label: <code>CREATE_PEER_CONNECTION</code>
          party: *b2d
        - !open-window-start-party
          src: *b2d
          dest: *b2i
        - !http-request &get_doc_4
          src: *b2i
          dest: *idp2
          method: GET
          url: /.wk/idp-proxy
          style: xhr
        - !http-response
          reply_to: *get_doc_4
          style: xhr
        - !postmessage
          dest: *b2i
          src: *b2d
          body: post message stuff
        - !postmessage
          body: 42
          dest: *b2d
          src: *b2i
        - !close-window-end-party
          src: *b2d
          dest: *b2i                         
        - !action
          label: <code>GET_OFFERxx</code>
          party: *b2d
# EXCHANGING OFFERS/ANSWERS
  - !http-request
    src: *b1d
    dest: *example
    parameters: offer
  - !Serial
    lifeline_style: annex_lifeline_dashed
    steps:
      - !http-request
        src: *example
        dest: *b2d
        parameters: offer
      - !action
        label: <code>GET_OFFER_SET_ANSWER</code>
        party: *b2d
      - !http-request
        src: *b2d
        dest: *example
        parameters: answer
      - !http-request
        src: *example
        dest: *b1d
        parameters: answer
# VERIFICATION
  - !Parallel
    steps:
      - !Serial # in browser 1
        steps:
         - !open-window-start-party
           src: *b1d
           dest: *b1i
         - !http-request &get_doc_2_2
           src: *b1i
           dest: *idp1
           method: GET
           url: /.wk/idp-proxy
         - !http-response
           reply_to: *get_doc_2_2
         - !script-action
           dest: *b1d
           src: *b1i
           label: <code>GET_IA_INFO</code>
           reversed: yes
           data: stuff
         - !script-action
           label: <code>SET_IA</code>
           dest: *b1d
           src: *b1i
           data: results
         - !end-party
           party: *b1i             
         - !action
           label: <code>GET_OFFER</code>
           party: *b1d
          
      - !Serial # in browser 2
        steps:
         - !open-window-start-party
           src: *b2d
           dest: *b2i
         - !http-request &get_doc_3_2
           src: *b2i
           dest: *idp2
           method: GET
           url: /.wk/idp-proxy
         - !http-response
           reply_to: *get_doc_3_2
         - !script-action
           dest: *b2d
           src: *b2i
           label: <code>GET_IA_INFO</code>
           reversed: yes
           data: stuff
         - !script-action
           label: <code>SET_IA</code>
           dest: *b2d
           src: *b2i
           data: results
         - !end-party
           party: *b2i             
         - !action
           label: <code>GET_OFFER</code>
           party: *b2d
# ESTABLISH DIRECT CONNECTION
  - --------------------------------
  - !comment
    label: "Establish direct connection:"
  - !http-request
    src: *b1d
    dest: *b2d
  - !comment
    label: "Manually set step counter:"
  - !http-request
    dest: *b1d
    src: *b2d
    counter: 1337
  - !my-custom-action # custom action, see annex_custom.py
    party: *idp2
# FINISH UP
  - !Parallel
    steps:
      - !end-party
        party: *b1d
      - !end-party
        party: *idp1
      - !end-party
        party: *example
      - !end-party
        party: *b2d
      - !end-party
        party: *idp2
    
  
